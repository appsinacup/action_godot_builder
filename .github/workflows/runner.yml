name: üîó GHA
on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to use for the build'
        required: false
        type: string
        default: 'godotengine/godot'
      tag:
        description: 'tag to use for the build'
        required: false
        type: string
        default: '4.4.1-stable'
      encryption_key:
        description: Encryption key for the build
        required: false
        type: string
        default: '7f5ddb606888db9a20dbf00b76f9b426f81e48d299c7093d5119b39967bae8f1'
      build_profile:
        description: 'Build profile file path.'
        required: false
        type: string
        default: ''
      module_flags:
        description: 'Extra module flags, e.g. module_webm_enabled=no'
        required: false
        type: string
        default: ''
      lto:
        description: 'LTO mode. Options: "none", "thin", "full"'
        required: false
        type: string
        default: "thin"

#concurrency:
#  group: ${{ github.workflow }}|${{ github.ref_name }}
#  cancel-in-progress: true

jobs:
  android-build:
    name: ü§ñ Android
    uses: ./.github/workflows/android_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}

  ios-build:
    name: üçè iOS
    uses: ./.github/workflows/ios_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}

  linux-build:
    name: üêß Linux
    uses: ./.github/workflows/linux_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
  
  macos-build:
    name: üçé macOS
    uses: ./.github/workflows/macos_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}

  windows-build:
    name: üèÅ Windows
    uses: ./.github/workflows/windows_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto == 'thin' && 'none' || inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}

  web-build:
    name: üåê Web
    uses: ./.github/workflows/web_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}

  release:
    name: üöÄ Create Release
    needs:
      - android-build
      - ios-build
      - linux-build
      - macos-build
      - windows-build
      - web-build
    uses: ./.github/workflows/release.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      encryption_key: ${{ inputs.encryption_key }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
