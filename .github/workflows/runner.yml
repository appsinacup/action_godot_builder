name: üîó GHA
on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to use for the build'
        required: false
        type: string
        default: 'appsinacup/gonuts'
      base-branch:
        description: 'Base branch to use for the builds'
        required: false
        type: string
        default: '4.5'
      tag:
        description: 'tag to use for the build'
        required: false
        type: string
        default: 'gonuts'
      build_profile:
        description: 'Build profile file path.'
        required: false
        type: string
        default: ''
      module_flags:
        description: 'Extra module flags, e.g. module_webm_enabled=no'
        required: false
        type: string
        default: ''
      template_module_flags:
        description: 'Extra module flags for template build, e.g. module_webm_enabled=no'
        required: false
        type: string
        default: 'disable_3d=yes deprecated="no"'
      lto:
        description: 'LTO mode. Options: "none", "thin", "full"'
        required: false
        type: string
        default: "lto=thin"

#concurrency:
#  group: ${{ github.workflow }}|${{ github.ref_name }}
#  cancel-in-progress: true

jobs:
  android-build:
    name: ü§ñ Android
    uses: ./.github/workflows/android_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  ios-build:
    name: üçè iOS
    uses: ./.github/workflows/ios_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  linux-build:
    name: üêß Linux
    uses: ./.github/workflows/linux_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto == 'lto=thin' && 'lto=none' || inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
  
  macos-build:
    name: üçé macOS
    uses: ./.github/workflows/macos_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  windows-build:
    name: üèÅ Windows
    uses: ./.github/workflows/windows_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto == 'lto=thin' && 'lto=none' || inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  web-build:
    name: üåê Web
    uses: ./.github/workflows/web_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  release:
    name: üöÄ Create Release
    needs:
      - android-build
      - ios-build
      - linux-build
      - macos-build
      - windows-build
      - web-build
    uses: ./.github/workflows/release.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      build_profile: ${{ inputs.build_profile }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
    secrets:
      BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
