name: üîó GHA
on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to use for the build'
        type: string
        default: 'appsinacup/gonuts'
      base-branch:
        description: 'Base branch to use for the builds'
        type: string
        default: '4.5'
      tag:
        description: 'tag to use for downloading the repo'
        type: string
        default: 'gonuts'
      tag_release:
        description: 'tag to use for releasing the build'
        type: string
        default: '4.5.beta'
      module_flags:
        description: 'Extra module flags, e.g. module_webm_enabled=no'
        type: string
        default: ''
      template_module_flags:
        description: 'Extra module flags for template build, e.g. module_webm_enabled=no'
        type: string
        default: 'disable_3d=yes'
      lto:
        description: 'LTO mode. Options: "none", "thin", "full"'
        type: choice
        default: "lto=thin"
        options:
          - "none"
          - "lto=thin"
          - "lto=full"
      use_encryption_key:
        description: 'Use Encryption Key.'
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  android-build:
    name: ü§ñ Android
    uses: ./.github/workflows/android_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  ios-build:
    name: üçè iOS
    uses: ./.github/workflows/ios_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  linux-build:
    name: üêß Linux
    uses: ./.github/workflows/linux_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto == 'lto=thin' && 'lto=none' || inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
  
  macos-build:
    name: üçé macOS
    uses: ./.github/workflows/macos_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  windows-build:
    name: üèÅ Windows
    uses: ./.github/workflows/windows_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto == 'lto=thin' && 'lto=none' || inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  web-build:
    name: üåê Web
    uses: ./.github/workflows/web_builds.yml
    with:
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      lto: ${{ inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  release:
    name: üöÄ Create Release
    needs:
      - android-build
      - ios-build
      - linux-build
      - macos-build
      - windows-build
      - web-build
    uses: ./.github/workflows/release.yml
    with:
      base-branch: ${{ inputs.base-branch }}
      repo: ${{ inputs.repo }}
      tag: ${{ inputs.tag }}
      tag_release: ${{ inputs.tag_release }}
      lto: ${{ inputs.lto }}
      module_flags: ${{ inputs.module_flags }}
      template_module_flags: ${{ inputs.template_module_flags }}
      use_encryption_key: ${{ inputs.use_encryption_key }}
    secrets:
      BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
